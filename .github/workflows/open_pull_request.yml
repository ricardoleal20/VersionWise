name: ğŸ¤– Automated Bump PR ğŸ”–

on:
  push:
    branches:
      - main
  # -------------------------------------------------------------------------- #
  # To use this Workflow, you need to specify this line on your job:           #
  # uses: ricardoleal20/versionwise/.github/workflows/open_pull_request.yml@main  #
  # -------------------------------------------------------------------------- #
  workflow_call:

# Generate the jobs for this
jobs:
  # Name of the main job for this
  bump_and_open_pr:
    runs-on: ubuntu-latest

    steps:
    # Check the code to see the differences
    - name: Checkout code ğŸ§‘â€ğŸ’»
      uses: actions/checkout@v3

    - name: Set Git user globally to github-actions â‘†
      uses: gotmax23/set-bot-git-user-action@main
      with:
        global: true
        bot: github-actions
        name: "Github Actions"

    - name: Set up Python ğŸ
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'

    - name: Load cached Poetry installation ğŸ“¦
      uses: actions/cache@v3
      with:
        path: ~/.local
        key: poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

    - name: Load cached venv ğŸ“¦
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

    - name: Install dependencies ğŸ—ï¸
      run: |
        pip install -Iv poetry==1.8.1
        poetry config virtualenvs.in-project true
        poetry install --no-interaction
        poetry run pip install PyGithub
        poetry run pip install maturin
        poetry run maturin develop

    - name: Perform version bump ğŸ”–
      run: |
        poetry run versionwise bump

    - name: Create and switch to bump branch ğŸ”
      run: |
        # Fetch all branches and tags
        git fetch origin
        
        # Configure git user
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
        
        # Make changes and commit them in the current branch first
        git add CHANGELOG.md
        git add pyproject.toml
        git add Cargo.toml
        git commit -m "ğŸ”– Bump: Update version and CHANGELOG"
        
        if git show-ref --verify --quiet refs/remotes/origin/bump-new-version; then
          # If branch exists, checkout and rebase
          git checkout bump-new-version
          git reset --hard origin/bump-new-version
          git cherry-pick main
        else
          # If branch doesn't exist, create it from current commit
          git checkout -b bump-new-version
        fi
        
        # Try push with --force-with-lease for safety
        git push --force-with-lease origin bump-new-version

    - name: Run Python script for open the PR ğŸ–¥ï¸
      run: poetry run python .github/utilities/open_pr.py
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BRANCH_NAME: ${{ github.ref }}
        REPO_NAME: ${{ github.repository }}

    # If the linter pass
    - run: echo "Version bumped and PR created! âœ…"
